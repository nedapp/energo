/* Plugin Name: Custom Menu Wizard
 * Version: 2.0.5
 * Author: Roger Barrett
 * 
 * Script for controlling this widget's options (in Admin -> Widgets)
*/
jQuery(function(f){var n={getDialog:function(d){return f("#"+d.find(".widget-custom-menu-wizard-onchange").data().cmwDialogId)},getSettings:function(d){var a={};f.each(d.serializeArray(),function(b,d){var c=d.name.replace(/.*\[([^\]]+)\]$/,"$1"),e="items"!==c&&/^-?\d+$/.test(d.value)?parseInt(d.value,10):d.value;a[c]=e;"items"===c&&(a._items_sep=!e||/(^\d+$|,)/.test(f.trim(e))?",":" ",e=f.map(e.split(/[,\s]+/),function(a){a=a?parseInt(a,10):0;return isNaN(a)||1>a?null:a}),a._items=e.join(a._items_sep))});
return a},buildRecurse:function(d,a,b){var f="",c,e;a=(a||0)+1;b=b||"";for(c in d)e=c.split("|")[0],f+='<li class="level-'+a+'" data-itemid="'+e+'" data-level="'+a+'" data-trace="'+b+'">',f+='<a class="ui-corner-all" href="#"><span class="ui-corner-all" title="#'+e+'">'+c.replace(/^\d+\|/,""),f+='</span></a><input type="checkbox" value="'+e+'" />',d[c]&&(f+="<ul>"+n.buildRecurse(d[c],a,e+(b?",":"")+b)+"</ul>"),f+="</li>";return f},changeMenu:function(d){d=f(this);var a=f(d.closest(".ui-dialog-content").data().cmwTriggerChange).closest("form").find(".widget-custom-menu-wizard-setitems"),
b=f.trim(a.val()),b=!b||/(^\d+$|,)/.test(b)?",":" ";a.val(d.closest(".cmw-demo-themenu").find("input").map(function(){return this.checked?this.value:null}).get().join(b)).trigger("change")},clickMenu:function(d){var a=f(this);d=["current-menu-item","current-menu-parent","current-menu-ancestor"];var b=a.closest(".ui-dialog-content"),g=b.find(".cmw-demo-themenu"),a=a.find("span").not("."+d[0]).parentsUntil(g,"li"),c,e=function(){this.title=this.title+" "+c.replace(" "," & ").replace(/-/g," ")};g.find("."+
d.join(",.")).removeClass(d.join(" ")).each(function(){this.title=this.title.replace(/\s.*$/,"")});for(g=0;g<a.length;g++)c=1===g?d.join(" "):d[0],a.eq(g).children("a").find("span").addClass(c).each(e),1<d.length&&d.shift();f(b.data().cmwTriggerChange).trigger("change");return!1},clickOutput:function(d){d=this.href.split("#")[1];f(this).closest(".ui-dialog-content").find(".cmw-demo-themenu a").eq(d).not(":has(.current-menu-item)").trigger("click");this.blur();return!1},clickShortcode:function(d){var a=
document;a.body.createTextRange?(a=a.body.createTextRange(),a.moveToElementText(this),a.select()):window.getSelection&&(d=window.getSelection(),a=a.createRange(),a.selectNodeContents(this),d.removeAllRanges(),d.addRange(a))},createMenu:function(d,a){var b=d.data(),g=d.find(".cmw-demo-themenu"),c=a.find(".widget-custom-menu-wizard-selectmenu"),e=parseInt(c.val(),10),m=g.find("ul").eq(0),k=g.data(),h;m.length&&m.data("menuid")===e||(h=f("<ul>"+n.buildRecurse(a.find(".widget-custom-menu-wizard-childrenof optgroup").data().cmwItems||
{})+"</ul>"),m.remove(),d.dialog("option","title",b.cmwTitlePrefix+c.find("option:selected").text()),k.maxLevel=0,g.append(h.data("menuid",e)).find("a").each(function(a){var b=f(this).parent("li").data().level;f(this).data("indx",a);b&&b>k.maxLevel&&(k.maxLevel=b)}))},init:function(d){var a=f(this);d=a.closest(".widget-custom-menu-wizard-onchange").data();var b=f("#"+d.cmwDialogId),a=a.closest("form");b.length||(b=f("<div/>",{id:d.cmwDialogId}).addClass("widget-custom-menu-wizard-dialog").data({cmwTriggerChange:d.cmwDialogTrigger,
cmwTitlePrefix:d.cmwDialogTitle}).append(f("<div/>").addClass("cmw-demo-theoutput").html("<strong>"+d.cmwDialogOutput+'</strong> &hellip;<div class="cmw-demo-theoutput-wrap ui-corner-all"></div><div class="cmw-demo-fallback"><small>'+d.cmwDialogFallback+"</small></div>")).append(f("<div/>").addClass("cmw-demo-themenu").html("<small><em>"+d.cmwDialogPrompt+"</em></small>")).append(f("<div/>").addClass("cmw-demo-theshortcode").html('<code class="ui-corner-all">[custom_menu_wizard]</code>')),b.find(".cmw-demo-themenu").on("click",
"a",n.clickMenu),b.find(".cmw-demo-themenu").on("change","input",n.changeMenu),b.find(".cmw-demo-theshortcode").on("click","code",n.clickShortcode),b.find(".cmw-demo-theoutput").on("click","a",n.clickOutput),b.dialog({autoOpen:!1,width:Math.min(0.8*f(window).width(),600),modal:!1}));b.dialog("isOpen")?b.dialog("close"):(n.createMenu(b,a),b.dialog("open"),f(d.cmwDialogTrigger).trigger("change"));this.blur();return!1},shortcode:function(d,a){var b={menu:[a.menu]},g,c,e;a.title&&(b.title=a.title);if(0<
a.filter)switch(a.filter_item){case 0:b.children_of="current";break;case -1:b.children_of="parent";break;case -2:b.children_of="root";break;default:b.children_of=[a.filter_item]}0>a.filter&&(b.items=a._items);0<a.filter&&0>a.filter_item&&a.fallback_no_ancestor&&(b.fallback_parent=a.fallback_include_parent_siblings?"siblings":a.fallback_include_parent?"parent":[1]);0<a.filter&&!a.filter_item&&a.fallback_no_children&&(b.fallback_current=a.fallback_nc_include_parent_siblings?"siblings":a.fallback_nc_include_parent?
"parent":[1]);1<a.start_level&&(b.start_level=[a.start_level]);0<a.depth&&(b.depth=[a.depth]);a.depth_rel_current&&0<a.depth&&(b.depth_rel_current=[1]);e=[];0<a.filter&&(a.include_parent_siblings?e.push("siblings"):a.include_parent&&e.push("parent"),a.include_ancestors&&e.push("ancestors"),e.length&&(b.include=e.join(" ")));e=[];0<a.filter&&a.title_from_parent&&e.push("parent");a.title_from_current&&e.push("current");e.length&&(b.title_from=e.join(" "));for(e in{flat_output:1,contains_current:1,ol_root:1,
ol_sub:1})a[e]&&(b[e]=[1]);g={container:"div",container_id:"",container_class:"",menu_class:"menu-widget",widget_class:""};for(e in g)a[e]!==g[e]&&(b[e]=a[e]);g={wrap_link:"before",wrap_link_text:"link_before"};for(e in g)(c=a[g[e]].toString().match(/^<(\w+)/))&&c[1]&&(b[e]=c[1]);g=[];for(e in b)g.push(f.isArray(b[e])?e+"="+b[e][0]:e+'="'+b[e]+'"');n.getDialog(d).find("code").text("[custom_menu_wizard "+g.join(" ")+"]")},show:function(d,a,b){a=a||f(this).closest("form");b=b||n.getSettings(a);d=n.getDialog(a);
var g=d.find(".cmw-demo-themenu"),c=g.find(".picked"),e="",m="",k=0,h=d.find(".cmw-demo-theoutput-wrap").empty(),p=["menu-widget"],q={};if(c.length&&h.length){0<b.filter&&b.title_from_parent&&(m=g.find(".the-parent").children("a").text()||"");!m&&b.title_from_current&&(m=g.find(".current-menu-item").text()||"");m||b.hide_title||(m=b.title||"");for(c.each(function(a){var c=f(this),d=c.data(),h=d.trace?d.trace.toString().split(","):[];a=d.itemid.toString();var g=1,c=c.children("a");if(!b.flat_output)for(q[a]=
1,a=0;a<h.length;a++)q[h[a]]&&g++;if(k)if(g>k)e+=b.ol_sub?"<ol>":"<ul>";else{for(;k>g;)--k,e+="</li>"+(b.ol_sub?"</ol>":"</ul>");e+="</li>"}e+='<li class="cmw-level-'+g+(d.included||"")+'"><a href="#'+c.data("indx")+'">'+c.text()+"</a>";k=g});1<k;)--k,e+="</li>"+(b.ol_sub?"</ol>":"</ul>");e+="</li>";p.push(d.find(".cmw-demo-fallback").data("fellback"));e=(b.ol_root?"<ol":"<ul")+' class="'+f.trim(p.join(" "))+'">'+e+(b.ol_root?"</ol>":"</ul>");h.html(e);m&&h.prepend("<h3>"+m+"</h3>");h.find("li").filter(function(){return!!f(this).children("ul, ol").length}).addClass("cmw-has-submenu")}n.shortcode(a,
b)},update:function(d){var a=f(this).closest("form"),b=n.getDialog(a),g,c,e,m,k,h,p,q,r,l,s;if(b.length&&b.dialog("isOpen")){f(d.target).hasClass("widget-custom-menu-wizard-selectmenu")&&n.createMenu(b,a);c=n.getSettings(a);e=c.include_parent;m=c.include_parent_siblings;k=b.find(".cmw-demo-themenu");g=k.data().maxLevel;p=k.find(".current-menu-item").closest("li");q=p.length?p.data().level:-1;h=k.find("li").removeData("included").removeClass("the-parent");0>c.filter&&(h=h.filter(function(){var a=f(this).children("input"),
b=-1<(c._items_sep+c._items+c._items_sep).indexOf(c._items_sep+a[0].value+c._items_sep);a.prop("checked",b);return b}),c._items||(h=f([])));h.length&&!p.length&&(c.contains_current||0<c.filter&&1>c.filter_item)&&(h=f([]));h.length&&0<c.filter&&(0<c.filter_item?l=h.filter("[data-itemid="+c.filter_item+"]"):c.filter_item?1===q&&c.fallback_no_ancestor?(l=p,e=e||c.fallback_include_parent,m=m||c.fallback_include_parent_siblings,r="cmw-fellback-to-current"):l=1===q?k:-1>c.filter_item?k.find(".current-menu-ancestor").eq(0).closest("li"):
k.find(".current-menu-parent").closest("li"):p.find("li").length?l=p:c.fallback_no_children&&(l=k.find(".current-menu-parent").closest("li"),l.length||(l=k),e=e||c.fallback_nc_include_parent,m=m||c.fallback_nc_include_parent_siblings,r="cmw-fellback-to-parent"));if(h.length)if(c.filter)l&&l.length?(s=c.depth_rel_current&&c.depth&&p.length&&l.has(p[0]).length?q-1+c.depth:c.depth?Math.max((l.data().level||0)+c.depth,c.start_level+c.depth-1):9999,h=l.find("li").filter(function(){var a=f(this).data().level;
return a>=c.start_level&&a<=s})):0<c.filter&&(h=f([]));else for(s=c.depth_rel_current&&c.depth&&p.length&&q>=c.start_level?q+c.depth-1:c.depth?c.start_level+c.depth-1:9999,q=1;q<=g;q++)if(q<c.start_level||q>s)h=h.not(".level-"+q);h.length&&0<c.filter&&l&&l.is("li")&&(m&&(h=h.add(l.siblings("li").data("included"," cmw-an-included-parent-sibling")),e=!0),c.include_ancestors&&(h=h.add(l.parentsUntil(k,"li").data("included"," cmw-an-included-ancestor")),e=!0),e&&(h=h.add(l.data("included"," cmw-the-included-parent"))));
!h.length||!c.contains_current||p.length&&h.filter(p).length||(h=f([]));h.length&&l&&l.is("li")&&l.addClass("the-parent");r=h.length?r:"";b.find(".cmw-demo-fallback").data("fellback",r).toggleClass("cmw-demo-fellback",!!r);k.toggleClass("cmw-demo-filteritems",0>c.filter).find(".picked").not(h.addClass("picked")).removeClass("picked");n.show.call(this,d,a,c)}}};f(document).on("click",".widget-custom-menu-wizard-collapsible-fieldset",function(){var d=f(this),a=d.find("input").eq(0),b=!a.prop("checked");
a.length&&(a.prop("checked",b),d.find("div").toggleClass("cmw-collapsed-fieldset",b),d.next("div")[b?"slideUp":"slideDown"]());this.blur();return!1}).on("change",".widget-custom-menu-wizard-listen",function(){var d=f(this.form),a=d.find(".widget-custom-menu-wizard-selectmenu"),b=d.find(".widget-custom-menu-wizard-showall").prop("checked"),g=d.find(".widget-custom-menu-wizard-showspecific").prop("checked"),d=d.find(".widget-custom-menu-wizard-childrenof"),c=parseInt(d.val(),10),e;a.is(this)&&(a=this.selectedIndex,
d.find("optgroup").filter(function(){var b=f(this).data("cmwOptgroupIndex")===a;b||f(this).remove();return b}).length||(e=f("#"+d.attr("id")+"_ignore").find("optgroup").eq(a).clone(),e.length&&(0<c&&(c=0,d.val(c)),e.find("option[selected]").removeAttr("selected").prop("selected",!1),d.append(e))));f.each({"":b||g,"-ss":g,"not-rp":b||g||0<=c,"not-ci":b||g||!!c},function(a,b){f(".widget-custom-menu-wizard-disableif"+a,this.form).toggleClass("cmw-colour-grey",b).find("input,select").prop("disabled",
b)})}).on("change",".widget-custom-menu-wizard-onchange",n.update).on("click",".widget-custom-menu-wizard-toggle-assist",n.init).on("click",".widget-action, .widget-control-close",function(){f(this).closest("div.widget").find(".widget-custom-menu-wizard-onchange").each(function(){var d=f("#"+f(this).data().cmwDialogId);d.length&&d.dialog("isOpen")&&d.dialog("close")})}).on("click",".widget-control-remove",function(d){f(this).closest("div.widget").find(".widget-custom-menu-wizard-onchange").each(function(){var a=
f("#"+f(this).data().cmwDialogId);a.length&&(a.dialog("destroy"),a.remove())})})});